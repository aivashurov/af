<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ß—Ç–æ –æ–± —ç—Ç–æ–º –¥—É–º–∞–µ—Ç –ê–ª–µ–∫—Å–µ–π –§.?</title>

  <style>
    :root {
      --font: system-ui, -apple-system, "SF Pro Text", "SF Pro Display", Segoe UI, Roboto, Arial, sans-serif;

      /* Light */
      --chat-bg: #f2f2f7;
      --nav-bg: rgba(248, 248, 248, 0.92);
      --nav-stroke: rgba(0,0,0,0.08);
      --text: #111;
      --subtext: rgba(17,17,17,0.55);

      --bubble-in-bg: #e5e5ea;
      --bubble-in-text: #111;

      --bubble-out-bg: #007aff;
      --bubble-out-text: #fff;

      --time-sep: rgba(60,60,67,0.6);

      --input-bg: rgba(255,255,255,0.98);
      --input-stroke: rgba(0,0,0,0.12);
      --input-text: #111;
      --placeholder: rgba(0,0,0,0.35);

      --accent: #007aff;

      --safe-bottom: env(safe-area-inset-bottom);
      --safe-top: env(safe-area-inset-top);
    }

    [data-theme="dark"] {
      --chat-bg: #000000;
      --nav-bg: rgba(18,18,18,0.92);
      --nav-stroke: rgba(255,255,255,0.08);
      --text: #fff;
      --subtext: rgba(235,235,245,0.6);

      --bubble-in-bg: #2c2c2e;
      --bubble-in-text: #fff;

      --bubble-out-bg: #0a84ff;
      --bubble-out-text: #fff;

      --time-sep: rgba(235,235,245,0.6);

      --input-bg: rgba(28,28,30,0.98);
      --input-stroke: rgba(255,255,255,0.12);
      --input-text: #fff;
      --placeholder: rgba(255,255,255,0.45);

      --accent: #0a84ff;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: var(--font);
      background: var(--chat-bg);
      color: var(--text);
    }

    .app {
      width: 100vw;
      height: 100vh;
      background: var(--chat-bg);
      display: grid;
      grid-template-rows: auto 1fr auto;
      position: relative;
      overflow: hidden;
    }

    .app::after {
      content:"";
      position:absolute; inset:0; pointer-events:none;
      background-image: url('data:image/svg+xml;utf8,\
        <svg xmlns="http://www.w3.org/2000/svg" width="220" height="220">\
          <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="1"/></filter>\
          <rect width="220" height="220" filter="url(%23n)" opacity="0.03"/>\
        </svg>');
      mix-blend-mode: soft-light;
    }

    header {
      padding-top: calc(var(--safe-top) + 6px);
      padding-bottom: 10px;
      background: var(--nav-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--nav-stroke);
      position: relative;
      z-index: 2;

      display: flex;
      justify-content: center;
      align-items: center;

      padding-inline: 12px;
      min-height: 72px;
      user-select: none;
    }

    .nav-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 0;
      transform: translateY(1px);
    }

    .nav-topline {
      display: flex; align-items: center; gap: 8px;
      min-width: 0;
    }

    .avatar {
      width: 32px; height: 32px; border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fff8, transparent 55%), linear-gradient(135deg, #6ad9ff, #8e7bff);
      display: grid; place-items: center;
      color: white; font-weight: 700; font-size: 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.5);
      flex: 0 0 auto;
    }

    .nav-title {
      font-size: 17px;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70vw;
      text-align: center;
    }

    .nav-sub {
      font-size: 12px;
      color: var(--subtext);
      display: flex; align-items: center; gap: 6px;
      justify-content: center;
      margin-top: -1px;
    }

    .dot {
      width: 6px; height: 6px; border-radius: 999px;
      background: #ffb45e; box-shadow: 0 0 6px #ffb45eaa;
    }
    .dot.ok { background: #71f3a1; box-shadow: 0 0 6px #71f3a1aa; }
    .dot.err { background: #ff7a7a; box-shadow: 0 0 6px #ff7a7aaa; }

    .nav-right {
      position: absolute;
      right: 8px;
      top: calc(var(--safe-top) + 8px);
      display: flex; align-items: center;
    }

    .theme-btn {
      background: transparent; border: none; cursor: pointer;
      color: var(--accent);
      font-size: 15px; font-weight: 700;
      padding: 6px 8px; border-radius: 10px;
    }
    .theme-btn:active { transform: translateY(1px); }

    main {
      padding: 8px 10px 12px;
      overflow: auto;
      scroll-behavior: smooth;
    }
    .chat {
      display: flex; flex-direction: column;
      gap: 6px;
    }

    .time-separator {
      align-self: center;
      margin: 10px 0 6px;
      font-size: 12px;
      color: var(--time-sep);
      font-weight: 600;
      letter-spacing: 0.2px;
      text-align: center;
    }

    .row {
      width: 100%;
      display: flex;
      align-items: flex-end;
      animation: pop .18s ease-out;
    }
    @keyframes pop {
      from { transform: translateY(6px) scale(.985); opacity:0; }
      to   { transform: translateY(0) scale(1); opacity:1; }
    }

    .row.in { justify-content: flex-start; padding-right: 20%; }
    .row.out { justify-content: flex-end; padding-left: 20%; }

    .bubble-wrap {
      display: flex; flex-direction: column;
      max-width: 100%;
      gap: 2px;
      position: relative;
    }

    .bubble {
      position: relative;
      max-width: 100%;
      padding: 9px 12px;
      font-size: 16px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* =========================
       iOS BUBBLES ‚Äî –§–ò–ù–ê–õ–¨–ù–´–ô –•–í–û–°–¢ (–æ–¥–∏–Ω–∞—Ä–Ω—ã–π)
       ========================= */

    .bubble.in {
      background: var(--bubble-in-bg);
      color: var(--bubble-in-text);
      border-radius: 18px 18px 18px 6px;
    }

    .bubble.in::after {
      content:"";
      position:absolute;
      left:-5px;
      bottom:3px;
      width:10px;
      height:10px;
      background: var(--bubble-in-bg);
      border-radius: 0 0 0 10px;
      transform: rotate(45deg);
      /* –ø—Ä—è—á–µ–º —à–æ–≤ –≤ —Ü–≤–µ—Ç –±–∞–±–ª–∞ */
      box-shadow: -2px 2px 0 var(--bubble-in-bg);
    }

    .bubble.out {
      background: var(--bubble-out-bg);
      color: var(--bubble-out-text);
      border-radius: 18px 18px 6px 18px;
      box-shadow: 0 6px 14px rgba(10,132,255,0.30);
    }

    .bubble.out::after {
      content:"";
      position:absolute;
      right:-5px;
      bottom:3px;
      width:10px;
      height:10px;
      background: var(--bubble-out-bg);
      border-radius: 0 0 10px 0;
      transform: rotate(45deg);
      box-shadow: 2px 2px 0 var(--bubble-out-bg);
    }

    .msg-time {
      font-size: 11px;
      color: var(--subtext);
      padding: 0 6px;
      user-select: none;
    }
    .row.in .msg-time { text-align: left; }
    .row.out .msg-time { text-align: right; }

    .empty {
      margin: 14px auto 0;
      padding: 8px 12px;
      width: fit-content;
      max-width: 92%;
      font-size: 14px;
      color: var(--subtext);
      background: rgba(60,60,67,0.10);
      border-radius: 999px;
      font-weight: 600;
      text-align: center;
    }
    [data-theme="dark"] .empty {
      background: rgba(235,235,245,0.12);
    }

    .typing {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      padding: 10px 12px;
      min-width: 54px;
    }
    .typing .dotty {
      width: 7px; height: 7px; border-radius: 999px;
      background: rgba(0,0,0,0.34);
      animation: bounce 1.1s infinite ease-in-out;
    }
    [data-theme="dark"] .typing .dotty {
      background: rgba(255,255,255,0.45);
    }
    .typing .dotty:nth-child(2) { animation-delay: .15s; }
    .typing .dotty:nth-child(3) { animation-delay: .3s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: .55; }
      40% { transform: translateY(-4px); opacity: 1; }
    }

    footer {
      padding: 8px 8px calc(8px + var(--safe-bottom));
      background: var(--nav-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-top: 1px solid var(--nav-stroke);
      display: grid;
      gap: 6px;
      z-index: 2;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: end;
      background: var(--input-bg);
      border: 1px solid var(--input-stroke);
      border-radius: 20px;
      padding: 6px 6px 6px 10px;
    }

    textarea {
      width: 100%;
      min-height: 32px;
      max-height: 110px;
      resize: none;
      outline: none;
      border: none;
      background: transparent;
      font-size: 16px;
      line-height: 1.35;
      color: var(--input-text);
      font-family: var(--font);
      padding: 6px 4px;
    }
    textarea::placeholder { color: var(--placeholder); }

    .send {
      width: 34px; height: 34px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: var(--accent);
      display: grid;
      place-items: center;
      color: white;
      font-weight: 900;
      box-shadow: 0 6px 14px rgba(10,132,255,0.45);
      transition: transform .08s ease;
    }
    .send:active { transform: translateY(1px) scale(0.98); }
    .send svg { width: 17px; height: 17px; transform: translateX(1px); }

    .footer-hint {
      display: flex;
      justify-content: flex-end;
      padding: 0 4px;
    }
    .chip {
      font-size: 11px;
      color: var(--subtext);
      background: rgba(60,60,67,0.10);
      border-radius: 999px;
      padding: 4px 8px;
      user-select:none;
      font-weight: 600;
    }
    [data-theme="dark"] .chip {
      background: rgba(235,235,245,0.12);
    }

    @media (max-width: 520px) {
      .bubble { font-size: 15px; }
      .row.in { padding-right: 10%; }
      .row.out { padding-left: 10%; }
      .nav-title { font-size: 16px; }
    }

    .sheet-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 9999;
    }
    .sheet-backdrop.show { display: flex; }

    .sheet {
      width: 100%;
      max-width: 520px;
      margin: 0 8px 8px;
      display: grid;
      gap: 8px;
      padding-bottom: env(safe-area-inset-bottom);
      animation: sheetUp .18s ease-out;
    }
    @keyframes sheetUp {
      from { transform: translateY(20px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }

    .sheet-group {
      background: rgba(255,255,255,0.9);
      border-radius: 14px;
      overflow: hidden;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(0,0,0,0.06);
    }
    [data-theme="dark"] .sheet-group {
      background: rgba(28,28,30,0.95);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .sheet-btn {
      width: 100%;
      border: none;
      background: transparent;
      padding: 14px 16px;
      font-size: 17px;
      text-align: center;
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      border-top: 1px solid rgba(0,0,0,0.06);
    }
    [data-theme="dark"] .sheet-btn {
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .sheet-btn:first-child { border-top: none; }
    .sheet-btn.destructive { color: #ff3b30; }
    .sheet-btn:active { background: rgba(0,0,0,0.05); }
    [data-theme="dark"] .sheet-btn:active { background: rgba(255,255,255,0.06); }
  </style>
</head>

<body>
  <div class="app" role="application" aria-label="–ß—Ç–æ –æ–± —ç—Ç–æ–º –¥—É–º–∞–µ—Ç –ê–ª–µ–∫—Å–µ–π –§.?">
    <header>
      <div class="nav-center">
        <div class="nav-topline">
          <div class="avatar">–ê–§</div>
          <div class="nav-title">–ê–ª–µ–∫—Å–µ–π –§–∏–ª–∏–ø–ø–æ–≤</div>
        </div>
        <div class="nav-sub">
          <span id="statusDot" class="dot"></span>
          <span id="statusText">–ó–∞–≥—Ä—É–∂–∞—é messages.csv‚Ä¶</span>
        </div>
      </div>

      <div class="nav-right">
        <button id="themeBtn" class="theme-btn" title="Light/Dark">‚òÄÔ∏è</button>
      </div>
    </header>

    <main id="main">
      <div id="chat" class="chat" aria-live="polite"></div>
      <div id="empty" class="empty" hidden>
        –ù–∞–ø–∏—à–∏ –ª—é–±—É—é —Ç–µ–º—É ‚Äî –ø–æ–ª—É—á–∏—à—å —Å–ª—É—á–∞–π–Ω—ã–π –æ—Ç–≤–µ—Ç üôÇ
      </div>
    </main>

    <footer>
      <div class="input-row">
        <textarea id="input" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea>
        <button id="sendBtn" class="send" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 11.5L21 3l-8.5 18-2.2-7.2L3 11.5z" fill="currentColor"/>
          </svg>
        </button>
      </div>
      <div class="footer-hint">
        <div class="chip">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</div>
      </div>
    </footer>
  </div>

  <div id="sheetBackdrop" class="sheet-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheet-group" id="sheetMain"></div>
      <div class="sheet-group">
        <button class="sheet-btn" data-action="cancel">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const htmlEl = document.documentElement;

    const chatEl = $("#chat");
    const emptyEl = $("#empty");
    const mainEl = $("#main");
    const inputEl = $("#input");
    const sendBtn = $("#sendBtn");
    const themeBtn = $("#themeBtn");
    const statusDot = $("#statusDot");
    const statusText = $("#statusText");
    const sheetBackdrop = $("#sheetBackdrop");
    const sheetMain = $("#sheetMain");

    let phrases = [];
    let lastSeparatorLabel = null;
    let pressedMessageEl = null;

    const ALWAYS_TOP_SYSTEM_TEXT = "–ß—Ç–æ –æ–± —ç—Ç–æ–º –¥—É–º–∞–µ—Ç –ê–ª–µ–∫—Å–µ–π –§.?";

    function setStatus(type, text) {
      statusDot.className = "dot " + (type || "");
      statusText.textContent = text;
    }

    function scrollToBottom() {
      mainEl.scrollTop = mainEl.scrollHeight;
    }

    function pad2(n){ return n < 10 ? "0"+n : ""+n; }
    function formatTime(date = new Date()) {
      return pad2(date.getHours()) + ":" + pad2(date.getMinutes());
    }

    function separatorLabelFor(date = new Date()) {
      const today = new Date();
      const d0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const d1 = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const diffDays = Math.round((d1 - d0) / (1000*60*60*24));

      if (diffDays === 0) return "–°–µ–≥–æ–¥–Ω—è";
      if (diffDays === -1) return "–í—á–µ—Ä–∞";

      const months = ["—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è","–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"];
      return `${d1.getDate()} ${months[d1.getMonth()]} ${d1.getFullYear()}`;
    }

    function addSeparator(label) {
      const sep = document.createElement("div");
      sep.className = "time-separator";
      sep.textContent = label;
      chatEl.appendChild(sep);
    }

    function maybeAddDateSeparator(date = new Date()) {
      const label = separatorLabelFor(date);
      if (label === lastSeparatorLabel) return;
      lastSeparatorLabel = label;
      addSeparator(label);
    }

    function addMessage(side, text, date = new Date(), { typing=false } = {}) {
      maybeAddDateSeparator(date);
      emptyEl.hidden = true;

      const row = document.createElement("div");
      row.className = `row ${side}`;

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";

      const bubble = document.createElement("div");
      bubble.className = `bubble ${side}`;

      if (typing) {
        bubble.classList.add("typing");
        bubble.innerHTML = `
          <span class="dotty"></span>
          <span class="dotty"></span>
          <span class="dotty"></span>
        `;
        bubble.setAttribute("data-typing","1");
      } else {
        bubble.textContent = text;
      }

      const time = document.createElement("div");
      time.className = "msg-time";
      time.textContent = formatTime(date);

      wrap.appendChild(bubble);
      wrap.appendChild(time);
      row.appendChild(wrap);
      chatEl.appendChild(row);

      row.dataset.side = side;
      row.dataset.text = text;

      attachPressHandlers(row);
      scrollToBottom();
      return row;
    }

    function showEmptyIfNeeded() {
      if (!chatEl.children.length) emptyEl.hidden = false;
    }

    function randInt(n) { return Math.floor(Math.random()*n); }
    function pickRandomPhrase() {
      if (!phrases.length) return "–§—Ä–∞–∑ –Ω–µ—Ç üòÖ";
      return phrases[randInt(phrases.length)];
    }

    function detectDelimiter(text) {
      const firstLine = text.split(/\r?\n/)[0] || "";
      const commas = (firstLine.match(/,/g) || []).length;
      const semis  = (firstLine.match(/;/g) || []).length;
      return semis > commas ? ";" : ",";
    }

    function parseCSV(text) {
      const delim = detectDelimiter(text);
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

      for (let i=0; i<text.length; i++) {
        const c = text[i], next = text[i+1];

        if (inQuotes) {
          if (c === '"' && next === '"') { field += '"'; i++; }
          else if (c === '"') inQuotes = false;
          else field += c;
        } else {
          if (c === '"') inQuotes = true;
          else if (c === delim) { row.push(field); field=""; }
          else if (c === "\n") { row.push(field); rows.push(row); row=[]; field=""; }
          else if (c === "\r") {}
          else field += c;
        }
      }
      row.push(field);
      rows.push(row);
      return rows;
    }

    function rowsToPhrases(rows) {
      if (!rows || !rows.length) return [];
      const header = rows[0].map(h => (h||"").trim().toLowerCase());
      const hasHeader = header.some(h => h==="text" || h==="message" || h==="phrase");

      let startIdx = 0, textCol = 0;
      if (hasHeader) {
        startIdx = 1;
        textCol = header.indexOf("text");
        if (textCol === -1) textCol = 0;
      }

      const out = [];
      for (let i=startIdx; i<rows.length; i++) {
        const v = (rows[i][textCol] ?? rows[i][0] ?? "").toString().trim();
        if (v) out.push(v);
      }
      return out;
    }

    async function loadMessages() {
      try {
        setStatus("", "–ó–∞–≥—Ä—É–∂–∞—é messages.csv‚Ä¶");
        const res = await fetch("./messages.csv", { cache:"no-store" });
        if (!res.ok) throw new Error("CSV not found");

        const text = await res.text();
        phrases = rowsToPhrases(parseCSV(text));
        if (!phrases.length) throw new Error("CSV empty");

        setStatus("ok", "–§—Ä–∞–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
        renderInitialSystemMessage();
        showEmptyIfNeeded();
      } catch (e) {
        console.error(e);
        setStatus("err", "–û—à–∏–±–∫–∞ CSV");
        renderInitialSystemMessage();
        emptyEl.hidden = false;
        emptyEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å messages.csv. –ü—Ä–æ–≤–µ—Ä—å –∏–º—è –∏ —á—Ç–æ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å index.html.";
      }
    }

    function renderInitialSystemMessage() {
      if (chatEl.dataset.hasSystem === "1") return;
      chatEl.dataset.hasSystem = "1";
      addSeparator(ALWAYS_TOP_SYSTEM_TEXT);
      lastSeparatorLabel = null;
    }

    function autoResize() {
      inputEl.style.height = "auto";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 110) + "px";
    }

    function sendUserMessage() {
      const text = inputEl.value.trim();
      if (!text) return;

      addMessage("out", text, new Date());

      inputEl.value = "";
      autoResize();

      const typingRow = addMessage("in", "", new Date(), { typing: true });

      const delay = 650 + randInt(600);
      setTimeout(() => {
        const bubble = typingRow.querySelector(".bubble");
        const time = typingRow.querySelector(".msg-time");
        const phrase = pickRandomPhrase();

        bubble.classList.remove("typing");
        bubble.removeAttribute("data-typing");
        bubble.textContent = phrase;

        typingRow.dataset.text = phrase;
        time.textContent = formatTime(new Date());

        scrollToBottom();
      }, delay);
    }

    inputEl.addEventListener("input", autoResize);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendUserMessage();
      }
    });
    sendBtn.addEventListener("click", sendUserMessage);

    function applyTheme(theme) {
      htmlEl.setAttribute("data-theme", theme);
      localStorage.setItem("imessage-theme", theme);
      themeBtn.textContent = theme === "dark" ? "üåô" : "‚òÄÔ∏è";
    }
    function initTheme() {
      const saved = localStorage.getItem("imessage-theme");
      if (saved === "dark" || saved === "light") return applyTheme(saved);
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      applyTheme(prefersDark ? "dark" : "light");
    }
    themeBtn.addEventListener("click", () => {
      const current = htmlEl.getAttribute("data-theme") || "light";
      applyTheme(current === "light" ? "dark" : "light");
    });

    function openSheetFor(rowEl) {
      pressedMessageEl = rowEl;
      const side = rowEl.dataset.side;

      sheetMain.innerHTML = "";

      const copyBtn = document.createElement("button");
      copyBtn.className = "sheet-btn";
      copyBtn.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
      copyBtn.dataset.action = "copy";
      sheetMain.appendChild(copyBtn);

      if (side === "in") {
        const regenBtn = document.createElement("button");
        regenBtn.className = "sheet-btn";
        regenBtn.textContent = "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ";
        regenBtn.dataset.action = "regen";
        sheetMain.appendChild(regenBtn);
      }

      const clearBtn = document.createElement("button");
      clearBtn.className = "sheet-btn destructive";
      clearBtn.textContent = "–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç";
      clearBtn.dataset.action = "clear";
      sheetMain.appendChild(clearBtn);

      sheetBackdrop.classList.add("show");
      sheetBackdrop.setAttribute("aria-hidden","false");
    }

    function closeSheet() {
      sheetBackdrop.classList.remove("show");
      sheetBackdrop.setAttribute("aria-hidden","true");
      pressedMessageEl = null;
    }

    sheetBackdrop.addEventListener("click", (e) => {
      if (e.target === sheetBackdrop) closeSheet();
    });

    sheetBackdrop.addEventListener("click", async (e) => {
      const btn = e.target.closest(".sheet-btn");
      if (!btn || !pressedMessageEl) return;

      const action = btn.dataset.action;
      const side = pressedMessageEl.dataset.side;
      const bubble = pressedMessageEl.querySelector(".bubble");

      if (action === "cancel") { closeSheet(); return; }

      if (action === "copy") {
        const text = pressedMessageEl.dataset.text || bubble.textContent || "";
        try { await navigator.clipboard.writeText(text); } catch {}
      }

      if (action === "regen" && side === "in") {
        const newPhrase = pickRandomPhrase();
        bubble.textContent = newPhrase;
        pressedMessageEl.dataset.text = newPhrase;
        pressedMessageEl.querySelector(".msg-time").textContent = formatTime(new Date());
      }

      if (action === "clear") {
        chatEl.innerHTML = "";
        chatEl.dataset.hasSystem = "0";
        lastSeparatorLabel = null;
        renderInitialSystemMessage();
        showEmptyIfNeeded();
      }

      closeSheet();
    });

    let pressTimer = null;
    function attachPressHandlers(row) {
      const bubble = row.querySelector(".bubble");

      bubble.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        openSheetFor(row);
      });

      bubble.addEventListener("touchstart", () => {
        pressTimer = setTimeout(() => openSheetFor(row), 450);
      }, { passive: true });
      bubble.addEventListener("touchend", () => clearTimeout(pressTimer));
      bubble.addEventListener("touchmove", () => clearTimeout(pressTimer));

      bubble.addEventListener("mousedown", () => {
        pressTimer = setTimeout(() => openSheetFor(row), 500);
      });
      bubble.addEventListener("mouseup", () => clearTimeout(pressTimer));
      bubble.addEventListener("mouseleave", () => clearTimeout(pressTimer));
    }

    autoResize();
    initTheme();
    loadMessages();
  </script>
</body>
</html>
